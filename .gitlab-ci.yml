# Pipeline DevSecOps pour Dolibarr ERP/CRM
# Architecture complète avec contrôles de sécurité intégrés

stages:
  - build
  - test
  - security
  - quality
  - package
  - deploy

variables:
  # Variables d'environnement Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY_URL: ${CI_REGISTRY:-registry.gitlab.com}/${CI_PROJECT_PATH}
  IMAGE_NAME: dolibarr
  IMAGE_TAG: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
  LATEST_TAG: ${CI_COMMIT_REF_NAME}
  
  # SonarQube
  SONAR_PROJECT_KEY: dolibarr
  SONAR_HOST_URL: ${SONARQUBE_URL:-http://sonarqube:9000}
  
  # Trivy
  TRIVY_CACHE_DIR: .trivycache
  TRIVY_NO_PROGRESS: "true"
  TRIVY_SEVERITY: "CRITICAL,HIGH,MEDIUM"
  TRIVY_FORMAT: "gitlab"
  TRIVY_TIMEOUT: "5m"

# =============================================================================
# STAGE: BUILD
# =============================================================================

build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - |
      docker build \
        --tag $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG \
        --tag $REGISTRY_URL/$IMAGE_NAME:$LATEST_TAG \
        --tag $REGISTRY_URL/$IMAGE_NAME:latest \
        --file Dockerfile \
        .
    - docker push $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG
    - docker push $REGISTRY_URL/$IMAGE_NAME:$LATEST_TAG
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker push $REGISTRY_URL/$IMAGE_NAME:latest
      fi
  after_script:
    - docker logout
  artifacts:
    paths:
      - docker-images.txt
    expire_in: 1 week
  only:
    - branches
    - tags

# =============================================================================
# STAGE: TEST
# =============================================================================

test:php-syntax:
  stage: test
  image: php:8.1-cli
  script:
    - echo "Checking PHP syntax..."
    - |
      find htdocs -name "*.php" -type f ! -path "*/vendor/*" ! -path "*/includes/*" | \
      xargs -I {} php -l {} || exit 1
    - echo "✓ PHP syntax check passed"
  allow_failure: false
  only:
    - branches
    - merge_requests

test:dependencies:
  stage: test
  image: php:8.1-cli
  before_script:
    - apt-get update -qq && apt-get install -y -qq git unzip
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - php composer-setup.php --install-dir=/usr/local/bin --filename=composer
    - rm composer-setup.php
    - composer --version
  script:
    - echo "Checking Composer dependencies..."
    - cp composer.json.disabled composer.json
    - composer validate --no-interaction
    - composer install --no-interaction --prefer-dist --no-dev
    - echo "✓ Dependencies validated"
  allow_failure: false
  only:
    - branches
    - merge_requests

# =============================================================================
# STAGE: SECURITY
# =============================================================================

# SAST avec Semgrep
security:sast-semgrep:
  stage: security
  image: returntocorp/semgrep:latest
  script:
    - echo "Running Semgrep SAST analysis..."
    - |
      semgrep \
        --config=auto \
        --json \
        --output=semgrep-report.json \
        --error \
        .
    - echo "✓ Semgrep SAST analysis completed"
  artifacts:
    reports:
      sast: semgrep-report.json
    paths:
      - semgrep-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - merge_requests

# Scan des dépendances avec Trivy
security:dependency-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "Scanning dependencies for vulnerabilities..."
    - |
      trivy fs \
        --security-checks vuln,config \
        --severity $TRIVY_SEVERITY \
        --format $TRIVY_FORMAT \
        --output trivy-dependency-report.json \
        --cache-dir $TRIVY_CACHE_DIR \
        --timeout $TRIVY_TIMEOUT \
        .
    - echo "✓ Dependency scan completed"
  artifacts:
    reports:
      dependency_scanning: trivy-dependency-report.json
    paths:
      - trivy-dependency-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - merge_requests

# Scan des images Docker avec Trivy
security:container-scan:
  stage: security
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - build:docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - apk add --no-cache curl
    - wget -qO- https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - docker pull $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG
    - |
      trivy image \
        --severity $TRIVY_SEVERITY \
        --format $TRIVY_FORMAT \
        --output trivy-container-report.json \
        --cache-dir $TRIVY_CACHE_DIR \
        --timeout $TRIVY_TIMEOUT \
        --exit-code 0 \
        $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG || true
    - |
      # Vérifier les vulnérabilités critiques
      if trivy image --severity CRITICAL --exit-code 1 --format json --quiet $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG; then
        echo "❌ Critical vulnerabilities found!"
        exit 1
      fi
    - echo "✓ Container scan completed"
  artifacts:
    reports:
      container_scanning: trivy-container-report.json
    paths:
      - trivy-container-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - tags

# Scan de configuration Docker avec Trivy
security:dockerfile-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "Scanning Dockerfile for misconfigurations..."
    - |
      trivy config \
        --severity $TRIVY_SEVERITY \
        --format $TRIVY_FORMAT \
        --output trivy-dockerfile-report.json \
        --cache-dir $TRIVY_CACHE_DIR \
        .
    - echo "✓ Dockerfile scan completed"
  artifacts:
    reports:
      sast: trivy-dockerfile-report.json
    paths:
      - trivy-dockerfile-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - merge_requests

# =============================================================================
# STAGE: QUALITY
# =============================================================================

# Analyse de code avec SonarQube
quality:sonarqube:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: 0
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "Running SonarQube analysis..."
    - |
      sonar-scanner \
        -Dsonar.projectKey=$SONAR_PROJECT_KEY \
        -Dsonar.sources=htdocs \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONARQUBE_TOKEN \
        -Dsonar.php.version=8.1 \
        -Dsonar.exclusions=**/vendor/**,**/includes/**,**/node_modules/** \
        -Dsonar.coverage.exclusions=**/vendor/**,**/includes/** \
        -Dsonar.qualitygate.wait=true
    - echo "✓ SonarQube analysis completed"
  dependencies:
    - test:php-syntax
  allow_failure: false
  only:
    - branches
    - merge_requests

# =============================================================================
# STAGE: PACKAGE
# =============================================================================

package:docker-images:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - build:docker
    - security:container-scan
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Packaging Docker images..."
    - |
      echo "$REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG" > docker-images.txt
      echo "$REGISTRY_URL/$IMAGE_NAME:$LATEST_TAG" >> docker-images.txt
    - echo "✓ Images packaged and ready for deployment"
  artifacts:
    paths:
      - docker-images.txt
    expire_in: 1 month
  only:
    - branches
    - tags
  when: manual

# =============================================================================
# STAGE: DEPLOY
# =============================================================================

deploy:development:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  environment:
    name: development
    url: http://dolibarr-dev.example.com
  script:
    - echo "Deploying to development environment..."
    - |
      docker-compose -f docker-compose.dev.yml pull
      docker-compose -f docker-compose.dev.yml up -d
    - echo "✓ Deployment to development completed"
  dependencies:
    - package:docker-images
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  environment:
    name: production
    url: https://dolibarr.example.com
  script:
    - echo "Deploying to production environment..."
    - |
      # Vérifier que toutes les étapes de sécurité ont réussi
      echo "Checking security gates..."
      # Déploiement en production
      docker-compose -f docker-compose.prod.yml pull
      docker-compose -f docker-compose.prod.yml up -d
    - echo "✓ Deployment to production completed"
  dependencies:
    - package:docker-images
  only:
    - main
    - master
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: false

# =============================================================================
# JOBS DE NETTOYAGE
# =============================================================================

cleanup:old-images:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - echo "Cleaning up old Docker images..."
    - |
      docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      # Supprimer les images de plus de 30 jours
      # Note: Adapter selon vos besoins de rétention
    - echo "✓ Cleanup completed"
  only:
    - schedules
  when: manual

